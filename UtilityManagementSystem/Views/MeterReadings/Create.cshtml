@model UtilityManagementSystem.ViewModels.MeterReadingViewModel

@{
    ViewData["Title"] = "Register Reading";
}

<style>
    :root {
        --bg-body: transparent;
        --input-bg: #1F2228;
        --input-border: #2b2b40;
        --text-main: #ffffff;
        --text-muted: #cfcfcf;
        --color-primary: #007bff;
        --color-primary-hover: #0069d9;
        --status-active-bg: rgba(80, 205, 137, 0.2);
        --status-active-text: #50cd89;
        --status-faulty-bg: rgba(241, 65, 108, 0.2);
        --status-faulty-text: #f1416c;
        --info-box-bg: rgba(0, 123, 255, 0.05);
        --info-box-border: rgba(0, 123, 255, 0.3);
    }
    #MeterDetailsSection {
        background-color: var(--info-box-bg);
        border: 1px dashed var(--info-box-border);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 1.5rem;
        display: none;
    }

    .info-label {
        color: var(--text-muted);
        font-size: 0.75rem;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .info-value {
        color: var(--text-main);
        font-weight: 700;
        font-size: 1rem;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .status-active {
        background-color: var(--status-active-bg);
        color: var(--status-active-text);
    }

    .status-faulty {
        background-color: var(--status-faulty-bg);
        color: var(--status-faulty-text);
    }

    .prev-reading-val {
        color: var(--color-primary);
        font-size: 1.5rem;
        font-weight: 800;
    }
</style>
<h2>Register Reading</h2>
<br>
<form asp-action="Create" method="post" novalidate>
    @Html.AntiForgeryToken()

    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <div class="form-group w-50">
        <label asp-for="CustomerId"></label>
        <select asp-for="CustomerId"
                id="CustomerSelect"
                class="form-control"
                asp-items="ViewBag.CustomerList">
            <option value="">Select a Customer...</option>
        </select>
        <span asp-validation-for="CustomerId" class="text-danger"></span>
    </div>

    <div class="form-group w-50">
        <label asp-for="MeterId"></label>
        <select asp-for="MeterId"
                id="MeterSelect"
                class="form-control"
                disabled>
            <option value="">Select Customer First...</option>
        </select>
        <div id="MeterLoader" class="text-primary mt-1" style="display:none;">Loading...</div>
        <span asp-validation-for="MeterId" class="text-danger"></span>
    </div>


    <div id="MeterDetailsSection" class="border rounded p-3 mb-3" style="display:none; width:50%;">
        <div class="row mb-2">
            <div class="col">
                <small class="text-muted">Utility Type</small>
                <div id="InfoUtility"><strong>-</strong></div>
            </div>
            <div class="col">
                <small class="text-muted">Location</small>
                <div id="InfoLocation"><strong>-</strong></div>
            </div>
            <div class="col">
                <small class="text-muted">Status</small>
                <div id="InfoStatusBadge">-</div>
            </div>
        </div>

        <hr />

        <small class="text-muted">Previous Reading</small>
        <h5 id="InfoPrevious">0.00</h5>
    </div>

    <div class="form-group w-50">
        <label asp-for="ReadingDate"></label>
        <input asp-for="ReadingDate"
               id="ReadingDate"
               type="date"
               class="form-control" />
        <span asp-validation-for="ReadingDate" class="text-danger"></span>
    </div>

    <div class="form-group w-50">
        <label asp-for="CurrentReading"></label>
        <input asp-for="CurrentReading"
               type="number"
               step="0.01"
               class="form-control"
               placeholder="0.00" />
        <span asp-validation-for="CurrentReading" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary mt-3">
        Register Reading
    </button>

    <a asp-action="Index" class="btn btn-link mt-3">Cancel</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('ReadingDate');
            if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];

            const customerSelect = document.getElementById('CustomerSelect');
            const meterSelect = document.getElementById('MeterSelect');

            const serverCustomerId = "@(Model?.CustomerId ?? 0)";
            const serverMeterId = "@(Model?.MeterId ?? 0)";

            if (serverCustomerId && serverCustomerId !== "0") {
                customerSelect.value = serverCustomerId;
                loadMeters(serverCustomerId, serverMeterId);
            }

            customerSelect.addEventListener("change", function () {
                loadMeters(this.value, null);
            });

            meterSelect.addEventListener("change", function () {
                loadMeterDetails(this.value);
            });
        });

        async function loadMeters(cid, meterIdToRestore) {
            const ms = document.getElementById("MeterSelect");
            const loader = document.getElementById("MeterLoader");
            const box = document.getElementById("MeterDetailsSection");

            ms.innerHTML = '<option>Select Meter...</option>';
            ms.disabled = true;
            box.style.display = 'none';

            if (!cid) return;

            loader.style.display = 'block';

            try {
                const res = await fetch(`/MeterReadings/GetMetersByCustomer?customerId=${cid}`);
                const data = await res.json();

                if (data.length) {
                    ms.innerHTML = '<option value="">Select Meter...</option>';
                    data.forEach(m => ms.add(new Option(m.text, m.id)));
                    ms.disabled = false;

                    if (meterIdToRestore && meterIdToRestore !== "0") {
                        ms.value = meterIdToRestore;
                        loadMeterDetails(meterIdToRestore);
                    }
                } else {
                    ms.innerHTML = '<option>No meters found</option>';
                }
            } catch (e) {
                console.error(e);
            }

            loader.style.display = 'none';
        }

        async function loadMeterDetails(mid) {
            const box = document.getElementById("MeterDetailsSection");
            if (!mid) { box.style.display = 'none'; return; }

            try {
                const res = await fetch(`/MeterReadings/GetMeterDetails?meterId=${mid}`);
                const data = await res.json();

                document.getElementById("InfoUtility").innerText = data.utility;
                document.getElementById("InfoLocation").innerText = data.location;
                document.getElementById("InfoPrevious").innerText = (data.previousReading || 0).toFixed(2);

                const statusBox = document.getElementById("InfoStatusBadge");
                const status = data.status || "Unknown";
                let badgeClass = "status-active";
                if(status === "Faulty") badgeClass = "status-faulty";

                statusBox.innerHTML = `<span class="status-badge ${badgeClass}">${status}</span>`;

                box.style.display='block';
            } catch (e) { }
        }
    </script>
}
